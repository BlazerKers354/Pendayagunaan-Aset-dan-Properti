{% extends "layout.html" %}

{% block title %}Prediksi Harga Bangunan + Tanah{% endblock %}

{% block content %}
<!-- Custom Telkom Color Scheme -->
<style>
    :root {
        --telkom-red: #DC143C;
        --telkom-dark: #8B0000;
        --telkom-light: rgba(220, 20, 60, 0.1);
    }
    
    .back-btn {
        position: fixed;
        top: 100px;
        left: 30px;
        z-index: 1000;
        background: var(--telkom-red);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 12px 20px;
        box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3);
        transition: all 0.3s ease;
    }
    
    .back-btn:hover {
        background: var(--telkom-dark);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 20, 60, 0.4);
    }
    
    @media (max-width: 768px) {
        .back-btn {
            position: relative;
            top: auto;
            left: auto;
            margin-bottom: 20px;
            display: block;
            width: fit-content;
        }
    }
    
    .header-telkom {
        background: linear-gradient(135deg, var(--telkom-red), var(--telkom-dark));
        color: white;
        border-radius: 15px 15px 0 0;
        box-shadow: 0 4px 15px rgba(220, 20, 60, 0.2);
    }
    
    .main-card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    }
    
    .stat-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card.telkom-primary {
        background: linear-gradient(135deg, var(--telkom-red), #ff4757);
    }
    
    .stat-card.telkom-success {
        background: linear-gradient(135deg, #28a745, #20c997);
    }
    
    .stat-card.telkom-info {
        background: linear-gradient(135deg, #17a2b8, #0dcaf0);
    }
    
    .stat-card.telkom-warning {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
    }
    
    .stat-card.telkom-secondary {
        background: linear-gradient(135deg, #6c757d, #495057);
    }
    
    .stat-card.telkom-dark {
        background: linear-gradient(135deg, #343a40, #495057);
    }
    
    .icon-stat {
        font-size: 2.5rem;
        margin-bottom: 10px;
        opacity: 0.8;
    }
    
    .search-form {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
    }
    
    .form-control-modern {
        border-radius: 10px;
        border: 1px solid #e9ecef;
        padding: 12px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control-modern:focus {
        border-color: var(--telkom-red);
        box-shadow: 0 0 0 0.2rem rgba(220, 20, 60, 0.25);
    }
    
    .btn-telkom {
        background: var(--telkom-red);
        border: none;
        border-radius: 10px;
        padding: 12px 20px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-telkom:hover {
        background: var(--telkom-dark);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3);
    }
    
    .table-modern {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    }
    
    .table-modern thead th {
        background: linear-gradient(135deg, #343a40, #495057);
        color: white;
        border: none;
        padding: 15px 12px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
    }
    
    .table-modern tbody tr {
        transition: all 0.3s ease;
    }
    
    .table-modern tbody tr:hover {
        background: var(--telkom-light);
        transform: scale(1.005);
    }
    
    .table-modern tbody td {
        padding: 12px;
        border-top: 1px solid #f8f9fa;
        vertical-align: middle;
        font-size: 0.85rem;
    }
    
    .badge-telkom {
        background: var(--telkom-red);
        color: white;
        border-radius: 12px;
        padding: 4px 10px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    
    .export-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .export-btn:hover {
        background: linear-gradient(135deg, #20c997, #28a745);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }
    
    .pagination .page-link {
        color: var(--telkom-red);
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin: 0 2px;
        padding: 8px 12px;
        transition: all 0.3s ease;
    }
    
    .pagination .page-item.active .page-link {
        background-color: var(--telkom-red);
        border-color: var(--telkom-red);
        color: white;
    }
    
    .pagination .page-link:hover {
        color: white;
        background-color: var(--telkom-red);
        border-color: var(--telkom-red);
    }
    
    /* Tab Navigation Styling */
    .nav-tabs {
        border-bottom: 2px solid var(--telkom-red);
        background: #f8f9fa;
        border-radius: 15px 15px 0 0;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 600;
        padding: 15px 25px;
        border-radius: 0;
        transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link:hover {
        border: none;
        color: var(--telkom-red);
        background: rgba(220, 20, 60, 0.1);
    }
    
    .nav-tabs .nav-link.active {
        background: var(--telkom-red);
        color: white;
        border: none;
        box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3);
    }
    
    .nav-tabs .nav-link.active:hover {
        background: var(--telkom-dark);
        color: white;
    }
    
    /* Calculator Results Styling */
    .results-container {
        min-height: 300px;
    }

    .result-card {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid var(--telkom-red);
    }

    .result-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--telkom-red);
    }

    .result-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .table-modern {
            font-size: 0.75rem;
        }
        
        .table-modern thead th {
            padding: 8px 4px;
            font-size: 0.7rem;
        }
        
        .table-modern tbody td {
            padding: 6px 4px;
            font-size: 0.75rem;
        }
    }

    /* Additional table improvements */
    .table-responsive {
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    }

    .table-modern {
        margin-bottom: 0;
        font-size: 0.85rem;
    }

    .table-modern .text-truncate {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .table-modern .small {
        font-size: 0.8rem !important;
    }

    .table-modern .badge {
        font-size: 0.65rem;
        padding: 2px 6px;
    }

    /* Compact price display */
    .table-modern .price-compact {
        font-size: 0.8rem;
        font-weight: 600;
    }

    /* Better spacing for numeric columns */
    .table-modern .text-end {
        font-family: 'Courier New', monospace;
        font-weight: 500;
    }

    /* Loading animation */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Success animation for export */
    .export-success {
        animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    /* Custom scrollbar */
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: var(--telkom-red);
        border-radius: 10px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: var(--telkom-dark);
    }
</style>

<!-- Back Button -->
<a href="{{ url_for('main.manajemen_aset') }}" class="btn back-btn">
    <i class="fas fa-arrow-left me-2"></i>Kembali
</a>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card main-card">
                <div class="card-header header-telkom">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-home me-3" style="font-size: 2rem;"></i>
                        <div>
                            <h3 class="mb-1">Prediksi Harga Bangunan + Tanah Surabaya</h3>
                            <p class="mb-0 opacity-75">Sistem prediksi berbasis Machine Learning dengan akurasi tinggi</p>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs nav-fill" id="bangunan-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="data-bangunan-tab" data-bs-toggle="tab" data-bs-target="#data-bangunan" type="button" role="tab">
                                <i class="fas fa-database me-2"></i>Data Prediksi
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="calculator-bangunan-tab" data-bs-toggle="tab" data-bs-target="#calculator-bangunan" type="button" role="tab">
                                <i class="fas fa-calculator me-2"></i>Kalkulator Sewa
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="bangunan-tab-content">
                        <!-- Tab Data Prediksi -->
                        <div class="tab-pane fade show active p-4" id="data-bangunan" role="tabpanel">
                            <!-- Statistik Summary -->
                            {% if stats %}
                            <div class="row g-4 mb-5">
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="card stat-card telkom-primary text-white h-100">
                                        <div class="card-body text-center">
                                            <i class="fas fa-database icon-stat"></i>
                                            <h4 class="fw-bold">{{ "{:,}".format(stats[0]) }}</h4>
                                            <p class="mb-0">Total Properti</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="card stat-card telkom-success text-white h-100">
                                        <div class="card-body text-center">
                                            <i class="fas fa-chart-line icon-stat"></i>
                                            <h6>Rp {{ "{:,.0f}".format(stats[1]) }}</h6>
                                            <p class="mb-0">Harga Rata-rata</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="card stat-card telkom-info text-white h-100">
                                        <div class="card-body text-center">
                                            <i class="fas fa-home icon-stat"></i>
                                            <h6>{{ "{:,.0f}".format(stats[5]) }} m²</h6>
                                            <p class="mb-0">Luas Bangunan Avg</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="card stat-card telkom-warning text-white h-100">
                                        <div class="card-body text-center">
                                            <i class="fas fa-calculator icon-stat"></i>
                                            <h6>Rp {{ "{:,.0f}".format(stats[4]) }}</h6>
                                            <p class="mb-0">Harga/m² Rata-rata</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="card stat-card telkom-secondary text-white h-100">
                                        <div class="card-body text-center">
                                            <i class="fas fa-arrow-down icon-stat"></i>
                                            <h6>Rp {{ "{:,.0f}".format(stats[2] if stats[2] else 0) }}</h6>
                                            <p class="mb-0">Harga Minimum</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="card stat-card telkom-dark text-white h-100">
                                        <div class="card-body text-center">
                                            <i class="fas fa-arrow-up icon-stat"></i>
                                            <h6>Rp {{ "{:,.0f}".format(stats[3] if stats[3] else 0) }}</h6>
                                            <p class="mb-0">Harga Maksimum</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Filter Form -->
                            <div class="search-form">
                                <div class="row align-items-end">
                                    <div class="col-md-8">
                                        <form method="GET" class="row g-3">
                                            <div class="col-md-4">
                                                <label for="kecamatan" class="form-label fw-semibold">
                                                    <i class="fas fa-map-marker-alt me-2"></i>Kecamatan
                                                </label>
                                                <input type="text" class="form-control form-control-modern" 
                                                       id="kecamatan" name="kecamatan" 
                                                       placeholder="Nama kecamatan..." 
                                                       value="{{ filters.kecamatan or '' }}">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="min_luas" class="form-label fw-semibold">Luas Min (m²)</label>
                                                <input type="number" class="form-control form-control-modern" 
                                                       id="min_luas" name="min_luas" 
                                                       placeholder="0" 
                                                       value="{{ filters.min_luas or '' }}">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="max_luas" class="form-label fw-semibold">Luas Max (m²)</label>
                                                <input type="number" class="form-control form-control-modern" 
                                                       id="max_luas" name="max_luas" 
                                                       placeholder="1000" 
                                                       value="{{ filters.max_luas or '' }}">
                                            </div>
                                            <div class="col-md-2">
                                                <label for="kamar_tidur" class="form-label fw-semibold">Kamar Tidur</label>
                                                <select class="form-control form-control-modern" id="kamar_tidur" name="kamar_tidur">
                                                    <option value="">Semua</option>
                                                    {% for i in range(1, 6) %}
                                                    <option value="{{ i }}" {{ 'selected' if filters.kamar_tidur == i else '' }}>{{ i }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-12">
                                                <button type="submit" class="btn btn-telkom me-2">
                                                    <i class="fas fa-search me-2"></i>Cari
                                                </button>
                                                <a href="{{ url_for('main.prediksi_bangunan_tanah') }}" class="btn btn-outline-secondary">
                                                    <i class="fas fa-times me-2"></i>Reset
                                                </a>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button class="export-btn" onclick="exportToCSV()">
                                            <i class="fas fa-download me-2"></i>Export CSV
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Tabel Data -->
                            <div class="table-responsive">
                                <table class="table table-modern" id="prediksiTable">
                                    <thead>
                                        <tr>
                                            <th>Kecamatan</th>
                                            <th>Luas Tanah</th>
                                            <th>Luas Bangunan</th>
                                            <th>KT/KM</th>
                                            <th>Lantai</th>
                                            <th>Tahun</th>
                                            <th>Kondisi</th>
                                            <th>Prediksi Total</th>
                                            <th>Harga Tanah</th>
                                            <th>Harga Bangunan</th>
                                            <th>Harga/m²</th>
                                            <th>Model</th>
                                            <th>Confidence</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for prediction in predictions %}
                                        <tr>
                                            <td><span class="badge badge-telkom">{{ prediction[1] }}</span></td>
                                            <td class="text-end">{{ "{:,}".format(prediction[2]) }} m²</td>
                                            <td class="text-end">{{ "{:,}".format(prediction[3]) }} m²</td>
                                            <td class="text-center">
                                                <small>{{ prediction[4] }}/{{ prediction[5] }}</small>
                                            </td>
                                            <td class="text-center">{{ prediction[6] if prediction[6] else '-' }}</td>
                                            <td class="text-center">{{ prediction[7] }}</td>
                                            <td><small>{{ prediction[10] }}</small></td>
                                            <td class="text-end fw-bold text-primary">
                                                <strong>Rp {{ "{:,.0f}".format(prediction[17]) }}</strong>
                                            </td>
                                            <td class="text-end text-success">
                                                Rp {{ "{:,.0f}".format(prediction[18]) }}
                                            </td>
                                            <td class="text-end text-info">
                                                Rp {{ "{:,.0f}".format(prediction[19]) }}
                                            </td>
                                            <td class="text-end">
                                                Rp {{ "{:,}".format(prediction[20]|int) }}
                                            </td>
                                            <td><span class="badge bg-info text-dark">{{ prediction[21] }}</span></td>
                                            <td class="text-center">
                                                {% if prediction[22] %}
                                                <span class="badge bg-success">{{ "{:.1%}".format(prediction[22]) }}</span>
                                                {% else %}
                                                <span class="badge bg-secondary">N/A</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            {% if not predictions %}
                            <div class="text-center py-5">
                                <i class="fas fa-home fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Tidak ada data ditemukan</h5>
                                <p class="text-muted">Coba ubah kriteria pencarian Anda.</p>
                            </div>
                            {% endif %}

                            <!-- Pagination -->
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <p class="text-muted">Menampilkan {{ predictions|length }} dari {{ predictions|length }} data properti</p>
                                </div>
                                <div class="col-md-6">
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination justify-content-end">
                                            {% if page > 1 %}
                                            <li class="page-item">
                                                <a class="page-link" href="{{ url_for('main.prediksi_bangunan_tanah', page=page-1, **filters) }}">
                                                    <i class="fas fa-chevron-left me-1"></i>Previous
                                                </a>
                                            </li>
                                            {% endif %}
                                            
                                            <li class="page-item active">
                                                <span class="page-link">Halaman {{ page }}</span>
                                            </li>
                                            
                                            {% if predictions|length == 20 %}
                                            <li class="page-item">
                                                <a class="page-link" href="{{ url_for('main.prediksi_bangunan_tanah', page=page+1, **filters) }}">
                                                    Next<i class="fas fa-chevron-right ms-1"></i>
                                                </a>
                                            </li>
                                            {% endif %}
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                </div>
            </div>
        </div>
                        
                        <!-- Tab Kalkulator Sewa Bangunan + Tanah -->
                        <div class="tab-pane fade p-4" id="calculator-bangunan" role="tabpanel">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header bg-gradient-danger text-white">
                                            <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Kalkulator Sewa Bangunan + Tanah</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="rentBangunanForm">
                                                <div class="mb-3">
                                                    <label for="rentLocationBangunan" class="form-label">Lokasi/Kecamatan</label>
                                                    <select class="form-select" id="rentLocationBangunan" required>
                                                        <option value="">Pilih Kecamatan</option>
                                                        <option value="asemrowo">Asemrowo</option>
                                                        <option value="benowo">Benowo</option>
                                                        <option value="bubutan">Bubutan</option>
                                                        <option value="bulak">Bulak</option>
                                                        <option value="dukuh-pakis">Dukuh Pakis</option>
                                                        <option value="gayungan">Gayungan</option>
                                                        <option value="genteng">Genteng</option>
                                                        <option value="gubeng">Gubeng</option>
                                                        <option value="gunung-anyar">Gunung Anyar</option>
                                                        <option value="jambangan">Jambangan</option>
                                                        <option value="karang-pilang">Karang Pilang</option>
                                                        <option value="kenjeran">Kenjeran</option>
                                                        <option value="krembangan">Krembangan</option>
                                                        <option value="lakarsantri">Lakarsantri</option>
                                                        <option value="mulyorejo">Mulyorejo</option>
                                                        <option value="pabean-cantian">Pabean Cantian</option>
                                                        <option value="pakal">Pakal</option>
                                                        <option value="rungkut">Rungkut</option>
                                                        <option value="sambikerep">Sambikerep</option>
                                                        <option value="sawahan">Sawahan</option>
                                                        <option value="semampir">Semampir</option>
                                                        <option value="simokerto">Simokerto</option>
                                                        <option value="sukolilo">Sukolilo</option>
                                                        <option value="sukomanunggal">Sukomanunggal</option>
                                                        <option value="tambaksari">Tambaksari</option>
                                                        <option value="tandes">Tandes</option>
                                                        <option value="tegalsari">Tegalsari</option>
                                                        <option value="tenggilis-mejoyo">Tenggilis Mejoyo</option>
                                                        <option value="wiyung">Wiyung</option>
                                                        <option value="wonocolo">Wonocolo</option>
                                                        <option value="wonokromo">Wonokromo</option>
                                                    </select>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="rentAreaTanah" class="form-label">Luas Tanah (m²)</label>
                                                            <input type="number" class="form-control" id="rentAreaTanah" min="1" placeholder="Luas tanah" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="rentAreaBangunan" class="form-label">Luas Bangunan (m²)</label>
                                                            <input type="number" class="form-control" id="rentAreaBangunan" min="1" placeholder="Luas bangunan" required>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="rentJumlahLantai" class="form-label">Jumlah Lantai</label>
                                                    <select class="form-select" id="rentJumlahLantai" required>
                                                        <option value="">Pilih Jumlah Lantai</option>
                                                        <option value="1">1 Lantai</option>
                                                        <option value="2">2 Lantai</option>
                                                        <option value="3">3 Lantai</option>
                                                        <option value="4">4 Lantai</option>
                                                        <option value="5">5+ Lantai</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="rentDurationBangunan" class="form-label">Durasi Sewa</label>
                                                    <div class="row">
                                                        <div class="col-8">
                                                            <input type="number" class="form-control" id="rentDurationBangunan" min="1" placeholder="Durasi" required>
                                                        </div>
                                                        <div class="col-4">
                                                            <select class="form-select" id="rentDurationUnitBangunan">
                                                                <option value="months">Bulan</option>
                                                                <option value="years">Tahun</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="rentPurposeBangunan" class="form-label">Tujuan Penggunaan</label>
                                                    <select class="form-select" id="rentPurposeBangunan">
                                                        <option value="commercial">Komersial</option>
                                                        <option value="office">Perkantoran</option>
                                                        <option value="residential">Residensial</option>
                                                        <option value="industrial">Industri</option>
                                                        <option value="mixed">Campuran</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="rentRateBangunan" class="form-label">Persentase Sewa per Tahun (%)</label>
                                                    <input type="number" class="form-control" id="rentRateBangunan" min="0.1" max="15" step="0.1" value="3.5" placeholder="3.5">
                                                    <div class="form-text">Biasanya 3-8% dari nilai properti per tahun untuk bangunan</div>
                                                </div>
                                                <button type="submit" class="btn btn-danger w-100">
                                                    <i class="fas fa-calculator me-2"></i>Hitung Biaya Sewa
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header bg-gradient-success text-white">
                                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Hasil Perhitungan</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="rentBangunanResults" class="results-container">
                                                <div class="text-center text-muted py-5">
                                                    <i class="fas fa-calculator fa-3x mb-3"></i>
                                                    <p>Masukkan parameter untuk melihat estimasi biaya sewa bangunan + tanah</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function exportToCSV() {
    // Bangun URL dengan filter yang ada
    let url = '{{ url_for("main.api_prediksi_bangunan_tanah") }}?limit=1000';
    
    // Tambahkan filter jika ada
    const filters = {{ filters|tojson }};
    Object.keys(filters).forEach(key => {
        if (filters[key]) {
            url += '&' + key + '=' + encodeURIComponent(filters[key]);
        }
    });
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                downloadCSV(data.data, 'prediksi_harga_bangunan_tanah.csv');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Gagal export data');
        });
}

function downloadCSV(data, filename) {
    const csvContent = convertToCSV(data);
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function convertToCSV(data) {
    if (!data || data.length === 0) return '';
    
    const headers = [
        'Kecamatan', 'Luas Tanah (m²)', 'Luas Bangunan (m²)', 'Kamar Tidur', 'Kamar Mandi',
        'Jumlah Lantai', 'Tahun Dibangun', 'Daya Listrik', 'Sertifikat', 'Kondisi Properti',
        'Tingkat Keamanan', 'Aksesibilitas', 'Tipe Iklan', 'NJOP per m²', 'Rasio Bangunan/Tanah',
        'Umur Bangunan', 'Prediksi Harga Total', 'Prediksi Harga Tanah', 'Prediksi Harga Bangunan',
        'Harga per m² Bangunan', 'Model Predictor', 'Confidence Score'
    ];
    
    let csv = headers.join(',') + '\n';
    
    data.forEach(row => {
        const values = [
            row.kecamatan,
            row.luas_tanah_m2,
            row.luas_bangunan_m2,
            row.jumlah_kamar_tidur,
            row.jumlah_kamar_mandi,
            row.jumlah_lantai || '',
            row.tahun_dibangun,
            row.daya_listrik,
            row.sertifikat,
            row.kondisi_properti,
            row.tingkat_keamanan,
            row.aksesibilitas,
            row.tipe_iklan,
            row.njop_per_m2,
            row.rasio_bangunan_tanah,
            row.umur_bangunan,
            row.harga_prediksi_total,
            row.harga_prediksi_tanah,
            row.harga_prediksi_bangunan,
            row.harga_per_m2_bangunan,
            row.model_predictor,
            row.confidence_score || ''
        ];
        csv += values.map(v => `"${v}"`).join(',') + '\n';
    });
    
    return csv;
}

// Sorting functionality
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('prediksiTable');
    if (table) {
        // Add click handlers to sortable headers
        const headers = table.querySelectorAll('th');
        headers.forEach((header, index) => {
            if ([1, 2, 7, 8, 9, 10].includes(index)) { // Sortable columns
                header.style.cursor = 'pointer';
                header.title = 'Klik untuk mengurutkan';
                header.addEventListener('click', () => sortTable(index));
            }
        });
    }
});

function sortTable(columnIndex) {
    const table = document.getElementById('prediksiTable');
    const tbody = table.tBodies[0];
    const rows = Array.from(tbody.rows);
    
    const isAscending = table.getAttribute('data-sort-direction') !== 'asc';
    table.setAttribute('data-sort-direction', isAscending ? 'asc' : 'desc');
    
    rows.sort((a, b) => {
        const aVal = a.cells[columnIndex].textContent.trim();
        const bVal = b.cells[columnIndex].textContent.trim();
        
        // Handle numeric values
        const aNum = parseFloat(aVal.replace(/[^\d.-]/g, ''));
        const bNum = parseFloat(bVal.replace(/[^\d.-]/g, ''));
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return isAscending ? aNum - bNum : bNum - aNum;
        }
        
        // Handle text values
        return isAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    });
    
    rows.forEach(row => tbody.appendChild(row));
}
</script>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.table th {
    vertical-align: middle;
    border-top: none;
    font-size: 0.875rem;
}

.table td {
    font-size: 0.875rem;
}

.badge {
    font-size: 0.7em;
}

.table-responsive {
    border-radius: 0.25rem;
}

.table-sm th,
.table-sm td {
    padding: 0.3rem;
}

th[style*="cursor: pointer"]:hover {
    background-color: #495057 !important;
}

.form-group label {
    font-weight: 500;
    font-size: 0.875rem;
}

/* Tab Navigation Styling */
.nav-tabs {
    border-bottom: 2px solid #DC143C;
    background: #f8f9fa;
    border-radius: 15px 15px 0 0;
}

.nav-tabs .nav-link {
    border: none;
    color: #6c757d;
    font-weight: 600;
    padding: 15px 25px;
    border-radius: 0;
    transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover {
    border: none;
    color: #DC143C;
    background: rgba(220, 20, 60, 0.1);
}

.nav-tabs .nav-link.active {
    background: #DC143C;
    color: white;
    border: none;
    box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3);
}

.nav-tabs .nav-link.active:hover {
    background: #8B0000;
    color: white;
}

/* Calculator Results Styling */
.results-container {
    min-height: 300px;
}

.result-card {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    border-left: 4px solid #DC143C;
}

.result-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #DC143C;
}

.result-label {
    color: #6c757d;
    font-size: 0.9rem;
}
</style>

<script>
// Kalkulator Sewa Bangunan + Tanah
document.getElementById('rentBangunanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const location = document.getElementById('rentLocationBangunan').value;
    const areaTanah = parseFloat(document.getElementById('rentAreaTanah').value);
    const areaBangunan = parseFloat(document.getElementById('rentAreaBangunan').value);
    const jumlahLantai = parseInt(document.getElementById('rentJumlahLantai').value);
    const duration = parseFloat(document.getElementById('rentDurationBangunan').value);
    const durationUnit = document.getElementById('rentDurationUnitBangunan').value;
    const purpose = document.getElementById('rentPurposeBangunan').value;
    const rentRate = parseFloat(document.getElementById('rentRateBangunan').value) / 100;
    
    if (!location || !areaTanah || !areaBangunan || !jumlahLantai || !duration || !rentRate) {
        alert('Harap lengkapi semua field yang diperlukan');
        return;
    }
    
    // Estimasi harga tanah berdasarkan lokasi (per m²)
    const tanahPriceEstimates = {
        'gubeng': 8500000,
        'tegalsari': 7200000,
        'genteng': 9200000,
        'bubutan': 6800000,
        'simokerto': 5500000,
        'pabean-cantian': 4200000,
        'semampir': 4800000,
        'krembangan': 5200000,
        'kenjeran': 6200000,
        'bulak': 4500000,
        'sukolilo': 7800000,
        'rungkut': 6500000,
        'gunung-anyar': 5800000,
        'tenggilis-mejoyo': 6200000,
        'tambaksari': 5900000,
        'mulyorejo': 7500000,
        'sawahan': 6800000,
        'wonokromo': 7200000,
        'wonocolo': 6500000,
        'jambangan': 5800000,
        'gayungan': 6200000,
        'wiyung': 7800000,
        'karang-pilang': 5500000,
        'sukomanunggal': 6800000,
        'tandes': 5200000,
        'benowo': 4800000,
        'pakal': 4200000,
        'asemrowo': 3800000,
        'sambikerep': 5500000,
        'lakarsantri': 6200000,
        'dukuh-pakis': 6800000
    };
    
    // Estimasi harga bangunan berdasarkan lokasi (per m²)
    const bangunanPriceEstimates = {
        'gubeng': 4500000,
        'tegalsari': 4200000,
        'genteng': 4800000,
        'bubutan': 3800000,
        'simokerto': 3200000,
        'pabean-cantian': 2800000,
        'semampir': 3000000,
        'krembangan': 3200000,
        'kenjeran': 3500000,
        'bulak': 2900000,
        'sukolilo': 4200000,
        'rungkut': 3800000,
        'gunung-anyar': 3500000,
        'tenggilis-mejoyo': 3600000,
        'tambaksari': 3400000,
        'mulyorejo': 4100000,
        'sawahan': 3700000,
        'wonokromo': 3900000,
        'wonocolo': 3600000,
        'jambangan': 3400000,
        'gayungan': 3500000,
        'wiyung': 4200000,
        'karang-pilang': 3200000,
        'sukomanunggal': 3700000,
        'tandes': 3100000,
        'benowo': 2900000,
        'pakal': 2700000,
        'asemrowo': 2500000,
        'sambikerep': 3200000,
        'lakarsantri': 3500000,
        'dukuh-pakis': 3800000
    };
    
    const tanahPricePerM2 = tanahPriceEstimates[location] || 6000000;
    const bangunanPricePerM2 = bangunanPriceEstimates[location] || 3500000;
    
    // Faktor multiplier untuk jumlah lantai
    const lantaiMultiplier = {
        1: 1.0,
        2: 1.15,
        3: 1.25,
        4: 1.35,
        5: 1.45
    };
    
    // Faktor penyesuaian berdasarkan tujuan penggunaan
    const purposeMultiplier = {
        'commercial': 1.3,
        'office': 1.2,
        'residential': 0.9,
        'industrial': 1.0,
        'mixed': 1.15
    };
    
    const totalTanahValue = tanahPricePerM2 * areaTanah;
    const adjustedBangunanPrice = bangunanPricePerM2 * (lantaiMultiplier[jumlahLantai] || 1.0);
    const totalBangunanValue = adjustedBangunanPrice * areaBangunan;
    const totalPropertyValue = totalTanahValue + totalBangunanValue;
    
    const adjustedValue = totalPropertyValue * (purposeMultiplier[purpose] || 1.0);
    const annualRent = adjustedValue * rentRate;
    
    // Konversi durasi ke bulan
    const durationInMonths = durationUnit === 'years' ? duration * 12 : duration;
    const monthlyRent = annualRent / 12;
    const totalRent = monthlyRent * durationInMonths;
    
    // Tampilkan hasil
    const resultsContainer = document.getElementById('rentBangunanResults');
    resultsContainer.innerHTML = `
        <div class="result-card">
            <div class="result-label">Nilai Tanah</div>
            <div class="result-value">Rp ${totalTanahValue.toLocaleString('id-ID')}</div>
            <small class="text-muted">${areaTanah.toLocaleString('id-ID')} m² × Rp ${tanahPricePerM2.toLocaleString('id-ID')}/m²</small>
        </div>
        <div class="result-card">
            <div class="result-label">Nilai Bangunan</div>
            <div class="result-value">Rp ${totalBangunanValue.toLocaleString('id-ID')}</div>
            <small class="text-muted">${areaBangunan.toLocaleString('id-ID')} m² × Rp ${adjustedBangunanPrice.toLocaleString('id-ID')}/m² (${jumlahLantai} lantai)</small>
        </div>
        <div class="result-card">
            <div class="result-label">Total Nilai Properti</div>
            <div class="result-value">Rp ${totalPropertyValue.toLocaleString('id-ID')}</div>
        </div>
        <div class="result-card">
            <div class="result-label">Nilai Setelah Penyesuaian</div>
            <div class="result-value">Rp ${adjustedValue.toLocaleString('id-ID')}</div>
            <small class="text-muted">Tujuan: ${purpose.charAt(0).toUpperCase() + purpose.slice(1)}</small>
        </div>
        <div class="result-card">
            <div class="result-label">Sewa Tahunan</div>
            <div class="result-value">Rp ${annualRent.toLocaleString('id-ID')}</div>
            <small class="text-muted">${rentRate * 100}% dari nilai properti</small>
        </div>
        <div class="result-card">
            <div class="result-label">Sewa Bulanan</div>
            <div class="result-value">Rp ${monthlyRent.toLocaleString('id-ID')}</div>
        </div>
        <div class="result-card bg-gradient-danger text-white border-0">
            <div class="result-label text-white">Total Biaya Sewa</div>
            <div class="result-value text-white">Rp ${totalRent.toLocaleString('id-ID')}</div>
            <small class="text-white-50">${duration} ${durationUnit === 'years' ? 'tahun' : 'bulan'} (${durationInMonths} bulan)</small>
        </div>
    `;
});
</script>
{% endblock %}
