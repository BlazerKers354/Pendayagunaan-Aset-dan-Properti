{% extends "layout.html" %}

{% block title %}Prediksi Harga Tanah{% endblock %}

{% block content %}
<!-- Custom Telkom Color Scheme -->
<style>
    :root {
        --telkom-red: #DC143C;
        --telkom-dark: #8B0000;
        --telkom-light: rgba(220, 20, 60, 0.1);
    }
    
    .header-telkom {
        background: linear-gradient(135deg, var(--telkom-red), var(--telkom-dark));
        color: white;
        border-radius: 15px 15px 0 0;
        box-shadow: 0 4px 15px rgba(220, 20, 60, 0.2);
    }
    
    .stat-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card.telkom-primary {
        background: linear-gradient(135deg, var(--telkom-red), #ff4757);
    }
    
    .stat-card.telkom-success {
        background: linear-gradient(135deg, #28a745, #20c997);
    }
    
    .stat-card.telkom-info {
        background: linear-gradient(135deg, #17a2b8, #0dcaf0);
    }
    
    .stat-card.telkom-warning {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
    }
    
    .stat-card.telkom-secondary {
        background: linear-gradient(135deg, #6c757d, #495057);
    }
    
    .stat-card.telkom-dark {
        background: linear-gradient(135deg, #343a40, #212529);
    }
    
    .btn-telkom {
        background: var(--telkom-red);
        border-color: var(--telkom-red);
        color: white;
        border-radius: 10px;
        padding: 10px 20px;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(220, 20, 60, 0.3);
    }
    
    .btn-telkom:hover {
        background: var(--telkom-dark);
        border-color: var(--telkom-dark);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(220, 20, 60, 0.4);
    }
    
    .btn-outline-telkom {
        color: var(--telkom-red);
        border-color: var(--telkom-red);
        border-radius: 10px;
        padding: 10px 20px;
        transition: all 0.3s ease;
    }
    
    .btn-outline-telkom:hover {
        background: var(--telkom-red);
        border-color: var(--telkom-red);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(220, 20, 60, 0.4);
    }
    
    .main-card {
        border: none;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .table-modern {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    }
    
    .table-modern thead th {
        background: linear-gradient(135deg, #343a40, #495057);
        color: white;
        border: none;
        padding: 10px 8px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.3px;
        white-space: nowrap;
    }
    
    .table-modern tbody tr {
        transition: all 0.3s ease;
    }
    
    .table-modern tbody tr:hover {
        background: var(--telkom-light);
        transform: scale(1.005);
    }
    
    .table-modern tbody td {
        padding: 8px 6px;
        border-top: 1px solid #f8f9fa;
        vertical-align: middle;
        font-size: 0.8rem;
        white-space: nowrap;
    }
    
    .badge-telkom {
        background: var(--telkom-red);
        color: white;
        border-radius: 12px;
        padding: 3px 8px;
        font-size: 0.65rem;
        font-weight: 500;
    }
    
    .search-form {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
    }
    
    .form-control-modern {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 12px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control-modern:focus {
        border-color: var(--telkom-red);
        box-shadow: 0 0 0 0.2rem rgba(220, 20, 60, 0.25);
    }
    
    .icon-stat {
        font-size: 2.5rem;
        opacity: 0.8;
        margin-bottom: 10px;
    }
    
    .back-btn {
        position: fixed;
        top: 100px;
        left: 30px;
        z-index: 1000;
        background: var(--telkom-red);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 12px 20px;
        box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3);
        transition: all 0.3s ease;
    }
    
    .back-btn:hover {
        background: var(--telkom-dark);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 20, 60, 0.4);
    }
    
    .pagination .page-link {
        color: var(--telkom-red);
        border-color: #dee2e6;
        border-radius: 8px;
        margin: 0 2px;
    }
    
    .pagination .page-item.active .page-link {
        background-color: var(--telkom-red);
        border-color: var(--telkom-red);
    }
    
    .pagination .page-link:hover {
        color: white;
        background-color: var(--telkom-red);
        border-color: var(--telkom-red);
    }
    
    /* Tab Navigation Styling */
    .nav-tabs {
        border-bottom: 2px solid var(--telkom-red);
        background: #f8f9fa;
        border-radius: 15px 15px 0 0;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 600;
        padding: 15px 25px;
        border-radius: 0;
        transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link:hover {
        border: none;
        color: var(--telkom-red);
        background: rgba(220, 20, 60, 0.1);
    }
    
    .nav-tabs .nav-link.active {
        background: var(--telkom-red);
        color: white;
        border: none;
        box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3);
    }
    
    .nav-tabs .nav-link.active:hover {
        background: var(--telkom-dark);
        color: white;
    }
</style>

<!-- Back Button -->
<a href="{{ url_for('main.manajemen_aset') }}" class="btn back-btn">
    <i class="fas fa-arrow-left me-2"></i>Kembali
</a>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card main-card">
                <div class="card-header header-telkom">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-chart-line me-3" style="font-size: 2rem;"></i>
                        <div>
                            <h3 class="mb-1">Prediksi Harga Tanah Surabaya</h3>
                            <p class="mb-0 opacity-75">Sistem prediksi berbasis Machine Learning dengan akurasi tinggi</p>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs nav-fill" id="tanah-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-tanah" type="button" role="tab">
                                <i class="fas fa-database me-2"></i>Data Prediksi
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="calculator-tab" data-bs-toggle="tab" data-bs-target="#calculator-tanah" type="button" role="tab">
                                <i class="fas fa-calculator me-2"></i>Kalkulator Sewa
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="tanah-tab-content">
                        <!-- Tab Data Prediksi -->
                        <div class="tab-pane fade show active p-4" id="data-tanah" role="tabpanel">
                            <!-- Statistik Summary -->
                            {% if stats %}
                    <div class="row g-4 mb-5">
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="card stat-card telkom-primary text-white h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-database icon-stat"></i>
                                    <h4 class="fw-bold">{{ "{:,}".format(stats[0]) }}</h4>
                                    <p class="mb-0">Total Data</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="card stat-card telkom-success text-white h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line icon-stat"></i>
                                    <h6>Rp {{ "{:,.0f}".format(stats[1]) }}</h6>
                                    <p class="mb-0">Harga Rata-rata</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="card stat-card telkom-info text-white h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-arrow-down icon-stat"></i>
                                    <h6>Rp {{ "{:,.0f}".format(stats[2]) }}</h6>
                                    <p class="mb-0">Harga Minimum</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="card stat-card telkom-warning text-white h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-arrow-up icon-stat"></i>
                                    <h6>Rp {{ "{:,.0f}".format(stats[3]) }}</h6>
                                    <p class="mb-0">Harga Maksimum</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="card stat-card telkom-secondary text-white h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-calculator icon-stat"></i>
                                    <h6>Rp {{ "{:,.0f}".format(stats[4]) }}</h6>
                                    <p class="mb-0">Harga/m² Rata-rata</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="card stat-card telkom-dark text-white h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-map-marker-alt icon-stat"></i>
                                    <h4 class="fw-bold">{{ stats[5] }}</h4>
                                    <p class="mb-0">Kecamatan</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Filter Section -->
                    <div class="search-form">
                        <div class="row align-items-end">
                            <div class="col-md-8">
                                <form method="GET" class="d-flex gap-3">
                                    <div class="flex-grow-1">
                                        <label for="kecamatan" class="form-label fw-semibold">
                                            <i class="fas fa-search me-2"></i>Cari Kecamatan
                                        </label>
                                        <input type="text" class="form-control form-control-modern" 
                                               id="kecamatan" name="kecamatan" 
                                               placeholder="Masukkan nama kecamatan..." 
                                               value="{{ kecamatan }}">
                                    </div>
                                    <div class="d-flex gap-2 align-self-end">
                                        <button type="submit" class="btn btn-telkom">
                                            <i class="fas fa-search me-2"></i>Cari
                                        </button>
                                        {% if kecamatan %}
                                        <a href="{{ url_for('main.prediksi_tanah') }}" class="btn btn-outline-telkom">
                                            <i class="fas fa-times me-2"></i>Reset
                                        </a>
                                        {% endif %}
                                    </div>
                                </form>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-telkom" onclick="exportToCSV()">
                                    <i class="fas fa-download me-2"></i>Export CSV
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabel Data -->
                    <div class="table-responsive">
                        <table class="table table-modern" id="prediksiTable">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-map-marker-alt me-1"></i>Kecamatan</th>
                                    <th><i class="fas fa-building me-1"></i>Kelurahan</th>
                                    <th><i class="fas fa-ruler-combined me-1"></i>Luas (m²)</th>
                                    <th><i class="fas fa-money-bill-wave me-1"></i>NJOP/m²</th>
                                    <th><i class="fas fa-layer-group me-1"></i>Zona</th>
                                    <th><i class="fas fa-tag me-1"></i>Kelas</th>
                                    <th><i class="fas fa-certificate me-1"></i>Sertifikat</th>
                                    <th><i class="fas fa-chart-line me-1"></i>Prediksi</th>
                                    <th><i class="fas fa-calculator me-1"></i>Harga/m²</th>
                                    <th><i class="fas fa-robot me-1"></i>Model</th>
                                    <th><i class="fas fa-percentage me-1"></i>Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prediction in predictions %}
                                <tr>
                                    <td><span class="badge badge-telkom">{{ prediction[1] }}</span></td>
                                    <td class="text-truncate" style="max-width: 100px;">{{ prediction[2] }}</td>
                                    <td class="text-end fw-semibold small">{{ "{:,}".format(prediction[3]) }}</td>
                                    <td class="text-end small">{{ "{:,.0f}".format(prediction[4]|int) }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary" style="font-size: 0.6rem;">{{ prediction[5] }}</span>
                                    </td>
                                    <td class="small">{{ prediction[6] }}</td>
                                    <td><span class="badge bg-info" style="font-size: 0.6rem;">{{ prediction[7] }}</span></td>
                                    <td class="text-end fw-bold text-success small">
                                        {{ "{:,.0f}".format(prediction[8]) }}
                                    </td>
                                    <td class="text-end small">{{ "{:,}".format(prediction[9]|int) }}</td>
                                    <td><span class="badge bg-danger" style="font-size: 0.6rem;">{{ prediction[10] }}</span></td>
                                    <td class="text-center">
                                        {% if prediction[11] %}
                                        <span class="badge bg-success" style="font-size: 0.6rem;">{{ "{:.1%}".format(prediction[11]) }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary" style="font-size: 0.6rem;">N/A</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if not predictions %}
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-search text-muted" style="font-size: 4rem; opacity: 0.5;"></i>
                        </div>
                        <h4 class="text-muted mb-3">Tidak ada data ditemukan</h4>
                        <p class="text-muted mb-4">Coba ubah kriteria pencarian Anda atau pastikan nama kecamatan yang dimasukkan benar.</p>
                        <a href="{{ url_for('main.prediksi_tanah') }}" class="btn btn-telkom">
                            <i class="fas fa-refresh me-2"></i>Tampilkan Semua Data
                        </a>
                    </div>
                    {% endif %}

                    <!-- Pagination -->
                    <div class="row mt-4 align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle text-muted me-2"></i>
                                <span class="text-muted">Menampilkan <strong>{{ predictions|length }}</strong> data dari total database</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-end mb-0">
                                    {% if page > 1 %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('main.prediksi_tanah', page=page-1, kecamatan=kecamatan) }}">
                                            <i class="fas fa-chevron-left me-1"></i>Previous
                                        </a>
                                    </li>
                                    {% endif %}
                                    
                                    <li class="page-item active">
                                        <span class="page-link">Halaman {{ page }}</span>
                                    </li>
                                    
                                    {% if predictions|length == 20 %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('main.prediksi_tanah', page=page+1, kecamatan=kecamatan) }}">
                                            Next<i class="fas fa-chevron-right ms-1"></i>
                                        </a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                        
                        <!-- Tab Kalkulator Sewa -->
                        <div class="tab-pane fade p-4" id="calculator-tanah" role="tabpanel">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header bg-gradient-danger text-white">
                                            <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Kalkulator Sewa Tanah</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="rentTanahForm">
                                                <div class="mb-3">
                                                    <label for="rentLocation" class="form-label">Lokasi/Kecamatan</label>
                                                    <select class="form-select" id="rentLocation" required>
                                                        <option value="">Pilih Kecamatan</option>
                                                        <option value="asemrowo">Asemrowo</option>
                                                        <option value="benowo">Benowo</option>
                                                        <option value="bubutan">Bubutan</option>
                                                        <option value="bulak">Bulak</option>
                                                        <option value="dukuh-pakis">Dukuh Pakis</option>
                                                        <option value="gayungan">Gayungan</option>
                                                        <option value="genteng">Genteng</option>
                                                        <option value="gubeng">Gubeng</option>
                                                        <option value="gunung-anyar">Gunung Anyar</option>
                                                        <option value="jambangan">Jambangan</option>
                                                        <option value="karang-pilang">Karang Pilang</option>
                                                        <option value="kenjeran">Kenjeran</option>
                                                        <option value="krembangan">Krembangan</option>
                                                        <option value="lakarsantri">Lakarsantri</option>
                                                        <option value="mulyorejo">Mulyorejo</option>
                                                        <option value="pabean-cantian">Pabean Cantian</option>
                                                        <option value="pakal">Pakal</option>
                                                        <option value="rungkut">Rungkut</option>
                                                        <option value="sambikerep">Sambikerep</option>
                                                        <option value="sawahan">Sawahan</option>
                                                        <option value="semampir">Semampir</option>
                                                        <option value="simokerto">Simokerto</option>
                                                        <option value="sukolilo">Sukolilo</option>
                                                        <option value="sukomanunggal">Sukomanunggal</option>
                                                        <option value="tambaksari">Tambaksari</option>
                                                        <option value="tandes">Tandes</option>
                                                        <option value="tegalsari">Tegalsari</option>
                                                        <option value="tenggilis-mejoyo">Tenggilis Mejoyo</option>
                                                        <option value="wiyung">Wiyung</option>
                                                        <option value="wonocolo">Wonocolo</option>
                                                        <option value="wonokromo">Wonokromo</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="rentArea" class="form-label">Luas Tanah (m²)</label>
                                                    <input type="number" class="form-control" id="rentArea" min="1" placeholder="Masukkan luas tanah" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="rentDuration" class="form-label">Durasi Sewa</label>
                                                    <div class="row">
                                                        <div class="col-8">
                                                            <input type="number" class="form-control" id="rentDuration" min="1" placeholder="Durasi" required>
                                                        </div>
                                                        <div class="col-4">
                                                            <select class="form-select" id="rentDurationUnit">
                                                                <option value="months">Bulan</option>
                                                                <option value="years">Tahun</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="rentPurpose" class="form-label">Tujuan Penggunaan</label>
                                                    <select class="form-select" id="rentPurpose">
                                                        <option value="commercial">Komersial</option>
                                                        <option value="industrial">Industri</option>
                                                        <option value="residential">Residensial</option>
                                                        <option value="mixed">Campuran</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="rentRate" class="form-label">Persentase Sewa per Tahun (%)</label>
                                                    <input type="number" class="form-control" id="rentRate" min="0.1" max="10" step="0.1" value="2.5" placeholder="2.5">
                                                    <div class="form-text">Biasanya 2-5% dari nilai properti per tahun</div>
                                                </div>
                                                <button type="submit" class="btn btn-danger w-100">
                                                    <i class="fas fa-calculator me-2"></i>Hitung Biaya Sewa
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header bg-gradient-success text-white">
                                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Hasil Perhitungan</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="rentTanahResults" class="results-container">
                                                <div class="text-center text-muted py-5">
                                                    <i class="fas fa-calculator fa-3x mb-3"></i>
                                                    <p>Masukkan parameter untuk melihat estimasi biaya sewa tanah</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function exportToCSV() {
    // Ambil data dari API untuk export
    const kecamatan = '{{ kecamatan }}';
    let url = '{{ url_for("main.api_prediksi_tanah") }}?limit=1000';
    if (kecamatan) {
        url += '&kecamatan=' + encodeURIComponent(kecamatan);
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                downloadCSV(data.data, 'prediksi_harga_tanah.csv');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Gagal export data');
        });
}

function downloadCSV(data, filename) {
    const csvContent = convertToCSV(data);
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function convertToCSV(data) {
    if (!data || data.length === 0) return '';
    
    const headers = [
        'Kecamatan', 'Kelurahan', 'Luas Tanah (m²)', 'NJOP per m²', 
        'Zona Nilai', 'Kelas Tanah', 'Jenis Sertifikat', 
        'Prediksi Harga', 'Harga per m²', 'Model Predictor', 'Confidence Score'
    ];
    
    let csv = headers.join(',') + '\n';
    
    data.forEach(row => {
        const values = [
            row.kecamatan,
            row.kelurahan,
            row.luas_tanah_m2,
            row.njop_tanah_per_m2,
            row.zona_nilai_tanah,
            row.kelas_tanah,
            row.jenis_sertifikat,
            row.harga_prediksi_tanah,
            row.harga_per_m2_tanah,
            row.model_predictor,
            row.confidence_score || ''
        ];
        csv += values.join(',') + '\n';
    });
    
    return csv;
}

// Auto-refresh every 5 minutes
setTimeout(() => {
    location.reload();
}, 300000);
</script>

<style>
/* Remove the old style block and replace with modern styling */
.table-modern tbody tr:nth-child(even) {
    background-color: #f8f9fa;
}

.table-modern tbody tr:nth-child(odd) {
    background-color: white;
}

@media (max-width: 768px) {
    .back-btn {
        position: relative;
        top: auto;
        left: auto;
        margin-bottom: 20px;
        display: block;
        width: fit-content;
    }
    
    .stat-card {
        margin-bottom: 15px;
    }
    
    .search-form {
        padding: 15px;
    }
    
    .table-responsive {
        font-size: 0.75rem;
    }
    
    .table-modern thead th {
        padding: 8px 4px;
        font-size: 0.7rem;
    }
    
    .table-modern tbody td {
        padding: 6px 4px;
        font-size: 0.75rem;
    }
}

/* Additional table improvements */
.table-responsive {
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
}

.table-modern {
    margin-bottom: 0;
    font-size: 0.85rem;
}

.table-modern .text-truncate {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.table-modern .small {
    font-size: 0.8rem !important;
}

.table-modern .badge {
    font-size: 0.65rem;
    padding: 2px 6px;
}

/* Compact price display */
.table-modern .price-compact {
    font-size: 0.8rem;
    font-weight: 600;
}

/* Better spacing for numeric columns */
.table-modern .text-end {
    font-family: 'Courier New', monospace;
    font-weight: 500;
}

/* Loading animation */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Success animation for export */
.export-success {
    animation: pulse 0.5s ease-in-out;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Custom scrollbar */
.table-responsive::-webkit-scrollbar {
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: var(--telkom-red);
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: var(--telkom-dark);
}

/* Calculator Results Styling */
.results-container {
    min-height: 300px;
}

.result-card {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    border-left: 4px solid var(--telkom-red);
}

.result-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--telkom-red);
}

.result-label {
    color: #6c757d;
    font-size: 0.9rem;
}
</style>

<script>
// Kalkulator Sewa Tanah
document.getElementById('rentTanahForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const location = document.getElementById('rentLocation').value;
    const area = parseFloat(document.getElementById('rentArea').value);
    const duration = parseFloat(document.getElementById('rentDuration').value);
    const durationUnit = document.getElementById('rentDurationUnit').value;
    const purpose = document.getElementById('rentPurpose').value;
    const rentRate = parseFloat(document.getElementById('rentRate').value) / 100;
    
    if (!location || !area || !duration || !rentRate) {
        alert('Harap lengkapi semua field yang diperlukan');
        return;
    }
    
    // Estimasi harga tanah berdasarkan lokasi (contoh data)
    const priceEstimates = {
        'gubeng': 8500000,
        'tegalsari': 7200000,
        'genteng': 9200000,
        'bubutan': 6800000,
        'simokerto': 5500000,
        'pabean-cantian': 4200000,
        'semampir': 4800000,
        'krembangan': 5200000,
        'kenjeran': 6200000,
        'bulak': 4500000,
        'sukolilo': 7800000,
        'rungkut': 6500000,
        'gunung-anyar': 5800000,
        'tenggilis-mejoyo': 6200000,
        'tambaksari': 5900000,
        'mulyorejo': 7500000,
        'sawahan': 6800000,
        'wonokromo': 7200000,
        'wonocolo': 6500000,
        'jambangan': 5800000,
        'gayungan': 6200000,
        'wiyung': 7800000,
        'karang-pilang': 5500000,
        'sukomanunggal': 6800000,
        'tandes': 5200000,
        'benowo': 4800000,
        'pakal': 4200000,
        'asemrowo': 3800000,
        'sambikerep': 5500000,
        'lakarsantri': 6200000,
        'dukuh-pakis': 6800000
    };
    
    const pricePerM2 = priceEstimates[location] || 6000000; // default price
    const totalPropertyValue = pricePerM2 * area;
    
    // Faktor penyesuaian berdasarkan tujuan penggunaan
    const purposeMultiplier = {
        'commercial': 1.2,
        'industrial': 1.0,
        'residential': 0.8,
        'mixed': 1.1
    };
    
    const adjustedValue = totalPropertyValue * (purposeMultiplier[purpose] || 1.0);
    const annualRent = adjustedValue * rentRate;
    
    // Konversi durasi ke bulan
    const durationInMonths = durationUnit === 'years' ? duration * 12 : duration;
    const monthlyRent = annualRent / 12;
    const totalRent = monthlyRent * durationInMonths;
    
    // Tampilkan hasil
    const resultsContainer = document.getElementById('rentTanahResults');
    resultsContainer.innerHTML = `
        <div class="result-card">
            <div class="result-label">Estimasi Nilai Properti</div>
            <div class="result-value">Rp ${totalPropertyValue.toLocaleString('id-ID')}</div>
            <small class="text-muted">${area.toLocaleString('id-ID')} m² × Rp ${pricePerM2.toLocaleString('id-ID')}/m²</small>
        </div>
        <div class="result-card">
            <div class="result-label">Nilai Setelah Penyesuaian</div>
            <div class="result-value">Rp ${adjustedValue.toLocaleString('id-ID')}</div>
            <small class="text-muted">Tujuan: ${purpose.charAt(0).toUpperCase() + purpose.slice(1)}</small>
        </div>
        <div class="result-card">
            <div class="result-label">Sewa Tahunan</div>
            <div class="result-value">Rp ${annualRent.toLocaleString('id-ID')}</div>
            <small class="text-muted">${rentRate * 100}% dari nilai properti</small>
        </div>
        <div class="result-card">
            <div class="result-label">Sewa Bulanan</div>
            <div class="result-value">Rp ${monthlyRent.toLocaleString('id-ID')}</div>
        </div>
        <div class="result-card bg-gradient-danger text-white border-0">
            <div class="result-label">Total Biaya Sewa</div>
            <div class="result-value">Rp ${totalRent.toLocaleString('id-ID')}</div>
            <small class="text-black-50">${duration} ${durationUnit === 'years' ? 'tahun' : 'bulan'} (${durationInMonths} bulan)</small>
        </div>
    `;
});

// Export function yang sudah ada
function exportToCSV() {
    // Ambil data dari API untuk export
    const kecamatan = '{{ kecamatan }}';
    let url = '{{ url_for("main.api_prediksi_tanah") }}?limit=1000';
    if (kecamatan) {
        url += '&kecamatan=' + encodeURIComponent(kecamatan);
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data.length > 0) {
                // Convert to CSV
                const headers = ['No', 'Kecamatan', 'Kelurahan', 'Jalan', 'Luas m2', 'Harga Prediksi'];
                const csvContent = [
                    headers.join(','),
                    ...data.data.map((row, index) => [
                        index + 1,
                        `"${row.kecamatan}"`,
                        `"${row.kelurahan}"`,
                        `"${row.jalan}"`,
                        row.luas_m2,
                        row.harga_prediksi
                    ].join(','))
                ].join('\n');
                
                // Download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `prediksi_tanah_${kecamatan || 'semua'}_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success animation
                const btn = event.target;
                btn.innerHTML = '<i class="fas fa-check me-2"></i>Berhasil!';
                btn.classList.add('export-success');
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-download me-2"></i>Export CSV';
                    btn.classList.remove('export-success');
                }, 2000);
            } else {
                alert('Tidak ada data untuk diexport');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi error saat export data');
        });
}
</script>
{% endblock %}
